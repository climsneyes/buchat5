<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TourAPI 테스트</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; }
        .test-container { max-width: 800px; margin: 0 auto; }
        .test-result { margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0056b3; }
        img { max-width: 200px; height: auto; margin: 10px 0; }
        .log { background: #f8f9fa; padding: 10px; margin: 10px 0; border-radius: 5px; font-family: monospace; white-space: pre-wrap; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>TourAPI 연동 테스트</h1>
        
        <div class="test-result info">
            <h3>테스트 목적</h3>
            <p>부산 관광지의 실제 사진을 TourAPI에서 가져오는지 확인합니다.</p>
        </div>

        <button onclick="testTourAPI()">TourAPI 기본 연결 테스트</button>
        <button onclick="testSpecificAttractions()">특정 관광지 이미지 테스트</button>
        <button onclick="clearLog()">로그 지우기</button>

        <div id="log" class="log"></div>
        <div id="results"></div>
    </div>

    <script>
        // TourAPI 설정
        const TOUR_API_KEY = 'kHGjR8DCO8hgSNlNhiEtmkrbtYpb9XvyGNOSSjKl0h4VnkGJNqFk+F7kKrLDFEuO+M4G/ggJkUBSy5XPqJk8wA==';
        const TOUR_API_BASE_URL = 'https://apis.data.go.kr/6260000/AttractionService/getAttractionKr';

        function log(message, type = 'info') {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logElement.textContent += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').textContent = '';
            document.getElementById('results').innerHTML = '';
        }

        // 관광지 이름 정규화 함수
        function normalizeAttractionName(name) {
            return name
                .replace(/\s+/g, '') // 공백 제거
                .replace(/[()[\]{}]/g, '') // 괄호 제거
                .replace(/[·•]/g, '') // 특수 구분자 제거
                .toLowerCase();
        }

        async function testTourAPI() {
            log('TourAPI 기본 연결 테스트 시작...');
            
            try {
                const params = new URLSearchParams({
                    serviceKey: TOUR_API_KEY,
                    pageNo: '1',
                    numOfRows: '5',
                    resultType: 'json'
                });
                
                const response = await fetch(`${TOUR_API_BASE_URL}?${params}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                log(`API 응답 성공! 상태: ${response.status}`);
                log(`응답 구조: ${JSON.stringify(data.response?.resultCode ? {resultCode: data.response.resultCode, resultMsg: data.response.resultMsg} : 'Unknown structure', null, 2)}`);
                
                if (data.response?.body?.items?.item) {
                    const items = Array.isArray(data.response.body.items.item) 
                        ? data.response.body.items.item 
                        : [data.response.body.items.item];
                    
                    log(`총 ${items.length}개의 관광지 데이터 확인`);
                    
                    // 첫 번째 항목 상세 정보 출력
                    if (items.length > 0) {
                        const firstItem = items[0];
                        log(`첫 번째 관광지: ${firstItem.place_nm || 'N/A'}`);
                        log(`이미지 URL들:`);
                        log(`  - main_img_normal: ${firstItem.main_img_normal || 'N/A'}`);
                        log(`  - main_img_thumb: ${firstItem.main_img_thumb || 'N/A'}`);
                        log(`  - main_img: ${firstItem.main_img || 'N/A'}`);
                        
                        // 이미지가 있으면 표시
                        const imageUrl = firstItem.main_img_normal || firstItem.main_img_thumb || firstItem.main_img;
                        if (imageUrl) {
                            const resultsDiv = document.getElementById('results');
                            resultsDiv.innerHTML += `
                                <div class="test-result success">
                                    <h4>${firstItem.place_nm}</h4>
                                    <img src="${imageUrl}" alt="${firstItem.place_nm}" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22200%22 height=%22150%22><rect width=%22100%25%22 height=%22100%25%22 fill=%22%23ddd%22/><text x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22>이미지 로드 실패</text></svg>'">
                                    <p>이미지 URL: ${imageUrl}</p>
                                </div>
                            `;
                        }
                    }
                } else {
                    log('관광지 데이터가 없습니다.', 'error');
                }
                
            } catch (error) {
                log(`API 요청 실패: ${error.message}`, 'error');
                console.error('API Error:', error);
            }
        }

        async function testSpecificAttractions() {
            const testAttractions = [
                '해운대 해수욕장',
                '광안리 해수욕장', 
                '태종대',
                '감천문화마을',
                '자갈치시장',
                '범어사',
                '부산타워',
                '해동용궁사'
            ];

            log('특정 관광지 이미지 테스트 시작...');
            
            try {
                const params = new URLSearchParams({
                    serviceKey: TOUR_API_KEY,
                    pageNo: '1',
                    numOfRows: '300',
                    resultType: 'json'
                });
                
                const response = await fetch(`${TOUR_API_BASE_URL}?${params}`);
                const data = await response.json();
                
                if (data.response?.body?.items?.item) {
                    const items = Array.isArray(data.response.body.items.item) 
                        ? data.response.body.items.item 
                        : [data.response.body.items.item];
                    
                    log(`총 ${items.length}개의 관광지 데이터에서 매칭 시도`);
                    
                    const resultsDiv = document.getElementById('results');
                    resultsDiv.innerHTML += '<div class="test-result info"><h3>관광지별 매칭 결과</h3></div>';
                    
                    for (const attractionName of testAttractions) {
                        log(`\n"${attractionName}" 검색 중...`);
                        
                        const normalizedSearchName = normalizeAttractionName(attractionName);
                        
                        // 1차: 정확한 매칭
                        let matchedItem = items.find(item => {
                            if (!item.place_nm) return false;
                            const normalizedItemName = normalizeAttractionName(item.place_nm);
                            return normalizedItemName === normalizedSearchName || 
                                   normalizedItemName.includes(normalizedSearchName) ||
                                   normalizedSearchName.includes(normalizedItemName);
                        });
                        
                        // 2차: 키워드 매칭
                        if (!matchedItem) {
                            const keywords = normalizedSearchName.split(/[^\w가-힣]+/).filter(k => k.length > 1);
                            matchedItem = items.find(item => {
                                if (!item.place_nm) return false;
                                const normalizedItemName = normalizeAttractionName(item.place_nm);
                                return keywords.some(keyword => 
                                    normalizedItemName.includes(keyword) || 
                                    (keyword.length > 2 && normalizedItemName.includes(keyword.substring(0, 2)))
                                );
                            });
                        }
                        
                        if (matchedItem) {
                            const imageUrl = matchedItem.main_img_normal || matchedItem.main_img_thumb || matchedItem.main_img;
                            log(`✓ 매칭 성공: "${matchedItem.place_nm}" -> ${imageUrl ? '이미지 있음' : '이미지 없음'}`);
                            
                            resultsDiv.innerHTML += `
                                <div class="test-result ${imageUrl ? 'success' : 'error'}">
                                    <h4>${attractionName} → ${matchedItem.place_nm}</h4>
                                    ${imageUrl ? `<img src="${imageUrl}" alt="${matchedItem.place_nm}" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22200%22 height=%22150%22><rect width=%22100%25%22 height=%22100%25%22 fill=%22%23ddd%22/><text x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22>이미지 로드 실패</text></svg>'"><br>URL: ${imageUrl}` : '<p>이미지 없음</p>'}
                                </div>
                            `;
                        } else {
                            log(`✗ 매칭 실패: "${attractionName}"`);
                            resultsDiv.innerHTML += `
                                <div class="test-result error">
                                    <h4>${attractionName}</h4>
                                    <p>매칭되는 관광지를 찾을 수 없습니다.</p>
                                </div>
                            `;
                        }
                    }
                } else {
                    log('API에서 데이터를 가져오지 못했습니다.', 'error');
                }
                
            } catch (error) {
                log(`특정 관광지 테스트 실패: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>