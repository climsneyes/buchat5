<!DOCTYPE html>
<html>
<head>
    <title>TourAPI 디버그 테스트</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .result { margin: 10px 0; padding: 10px; border: 1px solid #ccc; }
        .success { background: #e7f5e7; }
        .error { background: #ffe7e7; }
        .info { background: #e7f5ff; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>TourAPI 연결 문제 진단</h1>
    
    <h2>문제 원인 분석</h2>
    <div class="result info">
        <h3>현재 증상</h3>
        <p><code>Unexpected token '&lt;', "&lt;OpenAPI_S"... is not valid JSON</code></p>
        <p>→ 이것은 API가 JSON 대신 XML로 응답하고 있음을 의미합니다.</p>
    </div>

    <h2>가능한 원인들</h2>
    <div class="result">
        <h3>1. API 키 문제</h3>
        <ul>
            <li>인코딩된 키 vs 디코딩된 키</li>
            <li>키 유효성 확인 필요</li>
            <li>키 권한 설정 확인</li>
        </ul>
    </div>

    <div class="result">
        <h3>2. API 파라미터 문제</h3>
        <ul>
            <li>resultType이 제대로 작동하지 않음</li>
            <li>API가 기본적으로 XML 응답</li>
        </ul>
    </div>

    <div class="result">
        <h3>3. CORS 문제</h3>
        <ul>
            <li>브라우저에서 직접 호출할 때 제한</li>
            <li>프록시 서버 필요할 수 있음</li>
        </ul>
    </div>

    <button onclick="testBasicConnection()">기본 연결 테스트</button>
    <button onclick="testWithEncodedKey()">인코딩된 키로 테스트</button>
    <button onclick="testXmlParsing()">XML 파싱 테스트</button>
    <button onclick="clearResults()">결과 지우기</button>

    <div id="results"></div>

    <script>
        const ENCODED_KEY = 'kHGjR8DCO8hgSNlNhiEtmkrbtYpb9XvyGNOSSjKl0h4VnkGJNqFk%2BF7kKrLDFEuO%2BM4G%2FggJkUBSy5XPqJk8wA%3D%3D';
        const DECODED_KEY = 'kHGjR8DCO8hgSNlNhiEtmkrbtYpb9XvyGNOSSjKl0h4VnkGJNqFk+F7kKrLDFEuO+M4G/ggJkUBSy5XPqJk8wA==';
        const API_URL = 'https://apis.data.go.kr/6260000/AttractionService/getAttractionKr';

        function addResult(title, content, type = 'info') {
            const results = document.getElementById('results');
            results.innerHTML += `<div class="result ${type}"><h3>${title}</h3>${content}</div>`;
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        async function testBasicConnection() {
            addResult('기본 연결 테스트 시작', '디코딩된 키로 테스트 중...');
            
            try {
                const params = new URLSearchParams({
                    serviceKey: DECODED_KEY,
                    pageNo: '1',
                    numOfRows: '5',
                    resultType: 'json'
                });
                
                const url = `${API_URL}?${params}`;
                console.log('요청 URL:', url);
                
                const response = await fetch(url);
                const responseText = await response.text();
                
                addResult('응답 상태', `Status: ${response.status}<br>Headers: <pre>${JSON.stringify([...response.headers], null, 2)}</pre>`);
                addResult('응답 내용 (처음 1000자)', `<pre>${responseText.substring(0, 1000)}</pre>`);
                
                if (responseText.includes('INVALID_REQUEST_PARAMETER_ERROR')) {
                    addResult('오류 발견', 'API 키 또는 파라미터 문제입니다.', 'error');
                } else if (responseText.trim().startsWith('<')) {
                    addResult('XML 응답 확인', 'API가 XML로 응답하고 있습니다. 파싱 시도해보세요.', 'info');
                } else {
                    addResult('JSON 응답', 'JSON 응답을 받았습니다.', 'success');
                }
                
            } catch (error) {
                addResult('연결 오류', `Error: ${error.message}`, 'error');
            }
        }

        async function testWithEncodedKey() {
            addResult('인코딩된 키 테스트 시작', '인코딩된 키로 시도 중...');
            
            try {
                const params = new URLSearchParams({
                    serviceKey: ENCODED_KEY,
                    pageNo: '1',
                    numOfRows: '5',
                    resultType: 'json'
                });
                
                const response = await fetch(`${API_URL}?${params}`);
                const responseText = await response.text();
                
                addResult('인코딩된 키 응답', `<pre>${responseText.substring(0, 1000)}</pre>`);
                
            } catch (error) {
                addResult('인코딩된 키 오류', `Error: ${error.message}`, 'error');
            }
        }

        async function testXmlParsing() {
            addResult('XML 파싱 테스트', 'XML 응답을 파싱해보겠습니다...');
            
            try {
                const params = new URLSearchParams({
                    serviceKey: DECODED_KEY,
                    pageNo: '1',
                    numOfRows: '3'
                    // resultType 파라미터 제거하여 기본 XML 응답 받기
                });
                
                const response = await fetch(`${API_URL}?${params}`);
                const xmlText = await response.text();
                
                addResult('원본 XML', `<pre>${xmlText}</pre>`);
                
                // XML 파싱 시도
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
                
                const items = xmlDoc.querySelectorAll('item');
                let parsedData = `<h4>파싱된 관광지 데이터 (${items.length}개)</h4>`;
                
                Array.from(items).slice(0, 3).forEach((item, index) => {
                    const placeName = item.querySelector('place_nm')?.textContent || 'N/A';
                    const addr = item.querySelector('addr1')?.textContent || 'N/A';
                    const img = item.querySelector('main_img')?.textContent || 'N/A';
                    
                    parsedData += `
                        <div style="border: 1px solid #ddd; margin: 5px 0; padding: 5px;">
                            <strong>${index + 1}. ${placeName}</strong><br>
                            주소: ${addr}<br>
                            이미지: ${img}
                        </div>
                    `;
                });
                
                addResult('XML 파싱 결과', parsedData, 'success');
                
            } catch (error) {
                addResult('XML 파싱 오류', `Error: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>